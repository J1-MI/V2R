name: Build on EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Build app on EC2
      timeout-minutes: 60
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          cd ~/V2R
          git pull origin main
          # Optional clean-up to ensure space
          docker system prune -f || true
          # Build only (no restart here)
          docker-compose build app
        EOF


