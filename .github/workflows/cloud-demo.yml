name: Cloud Demo Setup on EC2

on:
  workflow_dispatch:
    inputs:
      demo_type:
        description: 'ë°ëª¨ íƒ€ì…'
        required: true
        type: choice
        options:
          - vulnerability-scan
          - compliance-check
          - full-demo
      target:
        description: 'ë°ëª¨ ëŒ€ìƒ (IP ë˜ëŠ” í˜¸ìŠ¤íŠ¸ëª…)'
        required: false
        default: ''

jobs:
  demo-setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Prepare Demo Environment
      timeout-minutes: 20
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          cd ~/V2R
          git pull origin main || true
          
          # Python í™˜ê²½ í™•ì¸
          if ! command -v python3 &> /dev/null; then
            echo "Python3 ì„¤ì¹˜ ì¤‘..."
            sudo yum install python3 python3-pip -y || sudo apt-get install python3 python3-pip -y
          fi
          
          # í•„ìš”í•œ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ê¸°ë³¸ì ì¸ ê²ƒë§Œ)
          if [ -f "requirements.txt" ]; then
            pip3 install --user -q requests psutil || true
          fi
          
          echo "âœ… ë°ëª¨ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ"
          echo "ë°ëª¨ íƒ€ì…: ${{ github.event.inputs.demo_type }}"
          echo "ëŒ€ìƒ: ${{ github.event.inputs.target || 'N/A' }}"
        EOF

    - name: Run Demo
      timeout-minutes: 30
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          cd ~/V2R
          
          DEMO_TYPE="${{ github.event.inputs.demo_type }}"
          TARGET="${{ github.event.inputs.target }}"
          
          case "$DEMO_TYPE" in
            vulnerability-scan)
              echo "ğŸ” ì·¨ì•½ì  ìŠ¤ìº” ë°ëª¨ ì‹¤í–‰"
              if [ -f "scripts/demo/vulnerability_scan_demo.py" ]; then
                python3 scripts/demo/vulnerability_scan_demo.py ${TARGET:+--target "$TARGET"}
              else
                echo "âš ï¸  ì·¨ì•½ì  ìŠ¤ìº” ë°ëª¨ ìŠ¤í¬ë¦½íŠ¸ê°€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              fi
              ;;
            compliance-check)
              echo "ğŸ“‹ CCE ì ê²€ ë°ëª¨ ì‹¤í–‰"
              if [ -f "scripts/compliance/cce_check.py" ]; then
                python3 scripts/compliance/cce_check.py ${TARGET:+--target "$TARGET"} --demo
              else
                echo "âš ï¸  CCE ì ê²€ ìŠ¤í¬ë¦½íŠ¸ê°€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              fi
              ;;
            full-demo)
              echo "ğŸ¯ ì „ì²´ ë°ëª¨ ì‹¤í–‰"
              if [ -f "scripts/demo/full_demo.py" ]; then
                python3 scripts/demo/full_demo.py ${TARGET:+--target "$TARGET"}
              else
                echo "âš ï¸  ì „ì²´ ë°ëª¨ ìŠ¤í¬ë¦½íŠ¸ê°€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              fi
              ;;
            *)
              echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ë°ëª¨ íƒ€ì…: $DEMO_TYPE"
              exit 1
              ;;
          esac
        EOF



