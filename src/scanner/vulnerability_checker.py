"""
취약점 체크 모듈
Redis, MongoDB 등의 무인증 및 설정 취약점을 체크합니다.
"""

import logging
import socket
import subprocess
from typing import Dict, Any, List, Optional
from datetime import datetime

logger = logging.getLogger(__name__)


class VulnerabilityChecker:
    """취약점 체크 클래스"""
    
    def __init__(self):
        pass
    
    def check_redis_unauth(self, host: str, port: int = 6379, timeout: int = 5) -> Dict[str, Any]:
        """
        Redis 무인증 취약점 체크
        
        Args:
            host: Redis 호스트
            port: Redis 포트
            timeout: 연결 타임아웃 (초)
        
        Returns:
            체크 결과 딕셔너리
        """
        finding_id = f"redis_unauth_{host}_{port}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        try:
            # Redis 연결 시도
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            result = sock.connect_ex((host, port))
            sock.close()
            
            if result != 0:
                return {
                    "finding_id": finding_id,
                    "type": "redis_unauth_check",
                    "title": "Redis 무인증 체크",
                    "result": "unreachable",
                    "description": f"Redis 서버에 연결할 수 없습니다 ({host}:{port})",
                    "severity": "Info"
                }
            
            # redis-cli로 인증 확인 시도
            try:
                # PING 명령어로 인증 없이 접근 가능한지 확인
                cmd = ["redis-cli", "-h", host, "-p", str(port), "PING"]
                result = subprocess.run(
                    cmd,
                    capture_output=True,
                    text=True,
                    timeout=timeout
                )
                
                if result.returncode == 0 and "PONG" in result.stdout:
                    # 인증 없이 접근 가능
                    return {
                        "finding_id": finding_id,
                        "type": "redis_unauth",
                        "title": "Redis 무인증 접근 가능",
                        "result": "vulnerable",
                        "description": f"Redis 서버({host}:{port})가 인증 없이 접근 가능합니다. 이는 심각한 보안 취약점입니다.",
                        "severity": "High",
                        "evidence": {
                            "host": host,
                            "port": port,
                            "command": " ".join(cmd),
                            "response": result.stdout.strip()
                        },
                        "cve_list": [],
                        "recommendation": "Redis에 AUTH 비밀번호를 설정하고, requirepass 옵션을 활성화하세요. 또한 방화벽으로 접근을 제한하세요."
                    }
                else:
                    # 인증 필요하거나 접근 불가
                    return {
                        "finding_id": finding_id,
                        "type": "redis_unauth_check",
                        "title": "Redis 인증 확인",
                        "result": "secure",
                        "description": f"Redis 서버({host}:{port})는 인증이 필요하거나 접근할 수 없습니다.",
                        "severity": "Info"
                    }
            except FileNotFoundError:
                # redis-cli가 없는 경우 소켓 레벨로만 확인
                logger.warning("redis-cli not found, using socket check only")
                return {
                    "finding_id": finding_id,
                    "type": "redis_unauth_check",
                    "title": "Redis 무인증 체크 (제한적)",
                    "result": "unknown",
                    "description": f"Redis 서버({host}:{port})에 연결 가능하지만 redis-cli가 없어 상세 확인이 불가능합니다.",
                    "severity": "Medium",
                    "recommendation": "redis-cli를 설치하거나 수동으로 Redis 인증 설정을 확인하세요."
                }
                
        except Exception as e:
            logger.error(f"Redis 체크 실패: {str(e)}")
            return {
                "finding_id": finding_id,
                "type": "redis_unauth_check",
                "title": "Redis 무인증 체크",
                "result": "error",
                "description": f"Redis 체크 중 오류 발생: {str(e)}",
                "severity": "Info"
            }
    
    def check_mongodb_unauth(self, host: str, port: int = 27017, timeout: int = 5) -> Dict[str, Any]:
        """
        MongoDB 무인증 취약점 체크
        
        Args:
            host: MongoDB 호스트
            port: MongoDB 포트
            timeout: 연결 타임아웃 (초)
        
        Returns:
            체크 결과 딕셔너리
        """
        finding_id = f"mongodb_unauth_{host}_{port}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        try:
            # MongoDB 연결 시도
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            result = sock.connect_ex((host, port))
            sock.close()
            
            if result != 0:
                return {
                    "finding_id": finding_id,
                    "type": "mongodb_unauth_check",
                    "title": "MongoDB 무인증 체크",
                    "result": "unreachable",
                    "description": f"MongoDB 서버에 연결할 수 없습니다 ({host}:{port})",
                    "severity": "Info"
                }
            
            # pymongo로 인증 확인 시도
            try:
                import pymongo
                from pymongo.errors import OperationFailure, ServerSelectionTimeoutError, ConfigurationError
                
                # PyMongo 버전 호환성 문제 해결: 
                # - serverSelectionTimeoutMS를 짧게 설정하여 빠른 실패
                # - directConnection=True로 단일 서버 연결
                try:
                    # PyMongo 버전 호환성 문제 해결을 위한 옵션
                    # wire version 체크를 우회하기 위해 직접 연결 사용
                    client = pymongo.MongoClient(
                        f"mongodb://{host}:{port}/",
                        serverSelectionTimeoutMS=timeout * 1000,
                        socketTimeoutMS=timeout * 1000,
                        connectTimeoutMS=timeout * 1000,
                        directConnection=True,  # 단일 서버 직접 연결 (wire version 체크 우회)
                        connect=False  # 즉시 연결하지 않음
                    )
                    # 수동으로 연결 시도
                    client.server_info()  # 서버 정보 조회로 연결 테스트
                except (ConfigurationError, Exception) as e:
                    # 버전 호환성 문제가 있는 경우 소켓 레벨로만 확인
                    logger.warning(f"MongoDB PyMongo 버전 호환성 문제: {str(e)}")
                    return {
                        "finding_id": finding_id,
                        "type": "mongodb_unauth_check",
                        "title": "MongoDB 무인증 체크 (제한적)",
                        "result": "unknown",
                        "description": f"MongoDB 서버({host}:{port})에 연결 가능하지만 PyMongo 버전 호환성 문제로 상세 확인이 불가능합니다. 소켓 레벨에서는 연결 가능합니다.",
                        "severity": "Medium",
                        "recommendation": "수동으로 MongoDB 인증 설정을 확인하세요."
                    }
                
                # 인증 없이 접근 시도
                try:
                    # admin 데이터베이스 목록 조회 시도
                    db_list = client.list_database_names()
                    
                    # 인증 없이 접근 가능
                    return {
                        "finding_id": finding_id,
                        "type": "mongodb_unauth",
                        "title": "MongoDB 무인증 접근 가능",
                        "result": "vulnerable",
                        "description": f"MongoDB 서버({host}:{port})가 인증 없이 접근 가능합니다. 데이터베이스 목록을 조회할 수 있습니다.",
                        "severity": "High",
                        "evidence": {
                            "host": host,
                            "port": port,
                            "databases": db_list[:10] if db_list else []  # 처음 10개만
                        },
                        "cve_list": [],
                        "recommendation": "MongoDB에 인증을 활성화하고, 방화벽으로 외부 접근을 제한하세요. 또한 --bind_ip 옵션을 사용하여 로컬 바인딩만 허용하세요."
                    }
                except OperationFailure:
                    # 인증 필요
                    return {
                        "finding_id": finding_id,
                        "type": "mongodb_unauth_check",
                        "title": "MongoDB 인증 확인",
                        "result": "secure",
                        "description": f"MongoDB 서버({host}:{port})는 인증이 필요합니다.",
                        "severity": "Info"
                    }
                except ServerSelectionTimeoutError:
                    return {
                        "finding_id": finding_id,
                        "type": "mongodb_unauth_check",
                        "title": "MongoDB 연결 타임아웃",
                        "result": "timeout",
                        "description": f"MongoDB 서버({host}:{port}) 연결 타임아웃",
                        "severity": "Info"
                    }
                    
            except ImportError:
                # pymongo가 없는 경우 소켓 레벨로만 확인
                logger.warning("pymongo not found, using socket check only")
                return {
                    "finding_id": finding_id,
                    "type": "mongodb_unauth_check",
                    "title": "MongoDB 무인증 체크 (제한적)",
                    "result": "unknown",
                    "description": f"MongoDB 서버({host}:{port})에 연결 가능하지만 pymongo가 없어 상세 확인이 불가능합니다.",
                    "severity": "Medium",
                    "recommendation": "pymongo를 설치하거나 수동으로 MongoDB 인증 설정을 확인하세요."
                }
                
        except Exception as e:
            logger.error(f"MongoDB 체크 실패: {str(e)}")
            return {
                "finding_id": finding_id,
                "type": "mongodb_unauth_check",
                "title": "MongoDB 무인증 체크",
                "result": "error",
                "description": f"MongoDB 체크 중 오류 발생: {str(e)}",
                "severity": "Info"
            }
    
    def check_all_vulnerabilities(self, targets: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        모든 취약점 체크 실행
        
        Args:
            targets: 체크 대상 리스트 [{"host": "...", "port": ..., "type": "redis|mongodb"}]
        
        Returns:
            체크 결과 리스트
        """
        results = []
        
        for target in targets:
            host = target.get("host")
            port = target.get("port")
            service_type = target.get("type", "").lower()
            
            if service_type == "redis":
                result = self.check_redis_unauth(host, port)
                results.append(result)
            elif service_type == "mongodb":
                result = self.check_mongodb_unauth(host, port)
                results.append(result)
            else:
                logger.warning(f"Unknown service type: {service_type}")
        
        return results

