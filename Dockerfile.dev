# 개발 환경용 Dockerfile
# 핫 리로드 및 개발 도구 포함

FROM continuumio/miniconda3:latest

WORKDIR /app

# 개발 도구 포함
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    wget \
    git \
    vim \
    nmap \
    postgresql-client \
    netcat-openbsd \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Go 설치 (Nuclei 빌드용)
RUN wget -q https://go.dev/dl/go1.21.5.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz && \
    rm -f go1.21.5.linux-amd64.tar.gz

# Go 환경 변수 설정
ENV PATH=$PATH:/usr/local/go/bin
ENV GOPATH=/root/go
ENV PATH=$PATH:$GOPATH/bin

# Conda 환경 설정
RUN conda update -n base -c defaults conda && \
    conda install -y python=3.11 && \
    conda clean -afy

# 개발용 Python 패키지 추가
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    # xgboost를 제외한 requirements.txt 생성 (GPU 의존성 문제로 인해)
    grep -v "^xgboost" requirements.txt > /tmp/requirements_no_xgboost.txt && \
    pip install --no-cache-dir -r /tmp/requirements_no_xgboost.txt && \
    pip install --no-cache-dir \
    pytest \
    pytest-cov \
    black \
    flake8 \
    ipython \
    ipdb && \
    # xgboost는 선택적 설치 (실패해도 계속 진행)
    (pip install --no-cache-dir xgboost 2>&1 | grep -v "nvidia" || echo "Warning: xgboost installation skipped (optional)") && \
    pip list --format=freeze > /tmp/installed_packages.txt && \
    echo "Installed packages:" && cat /tmp/installed_packages.txt | head -30 && \
    # 디스크 공간 정리
    pip cache purge && \
    rm -rf /tmp/* /var/tmp/* && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Nuclei 설치 (Go 소스에서 빌드)
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        echo "Installing Nuclei from source for architecture: $ARCH" && \
        cd /tmp && \
        git clone --depth 1 https://github.com/projectdiscovery/nuclei.git && \
        cd nuclei && \
        # 저장소 구조 확인
        echo "Checking directory structure..." && \
        ls -la && \
        # 여러 가능한 경로 시도
        if [ -d "cmd/nuclei" ]; then \
            echo "Building from cmd/nuclei" && \
            cd cmd/nuclei && \
            go build -o nuclei . && \
            mv nuclei /usr/local/bin/nuclei; \
        elif [ -d "v2/cmd/nuclei" ]; then \
            echo "Building from v2/cmd/nuclei" && \
            cd v2/cmd/nuclei && \
            go build -o nuclei . && \
            mv nuclei /usr/local/bin/nuclei; \
        else \
            echo "Trying to build from root with go build" && \
            (go build -o /usr/local/bin/nuclei ./cmd/nuclei 2>/dev/null || \
             go build -o /usr/local/bin/nuclei ./v2/cmd/nuclei 2>/dev/null || \
             (echo "Error: Cannot find nuclei source. Available directories:" && find . -type d -name "*nuclei*" | head -10 && exit 1)); \
        fi && \
        chmod +x /usr/local/bin/nuclei && \
        cd / && \
        rm -rf /tmp/nuclei && \
        /usr/local/bin/nuclei -version && \
        echo "Nuclei installed successfully" && \
        /usr/local/bin/nuclei -update-templates && \
        echo "Nuclei templates updated"; \
    else \
        echo "Warning: Nuclei installation skipped for architecture $ARCH (only x86_64 supported)"; \
    fi

# 환경 변수
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV FLASK_ENV=development
ENV PYTHONDONTWRITEBYTECODE=1

# 개발 모드 (코드 마운트)
# docker-compose에서 볼륨 마운트 사용

# 기본 명령어
CMD ["tail", "-f", "/dev/null"]  # 개발 서버는 docker-compose에서 실행

